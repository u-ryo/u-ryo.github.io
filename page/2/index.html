<!DOCTYPE html> <!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]--> <!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]--> <!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]--> <head> <meta charset="utf-8"> <title>u-ryo's blog</title> <meta name="author" content="u-ryo"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="canonical" href="http://u-ryo.github.io//page/2/"> <link href="/images/favicon-eec3051d5c356d1798bea1d8a3617c51.png" rel="icon"> <link href="/stylesheets/screen-212a3205d97b53ef71581e910c98f79c.css" media="screen, projection" rel="stylesheet" type="text/css"> <link href="atom.xml" rel="alternate" title="u-ryo's blog" type="application/atom+xml"> <script src="/javascripts/libs/jquery.min-663628f795cb62444143fde1ebdf2b5b.js" type="text/javascript"></script> <script src="/javascripts/modernizr-2.0-f86b862d5ee138da61daf47f24116ed7.js" type="text/javascript"></script> <script src="/javascripts/octopress-52bd0860c81b8af484852d75380d38f3.js" type="text/javascript"></script> <script src="/javascripts/github-2c23ec60bbc7e962f6324b25d8b2ae44.js" type="text/javascript"></script> <script src="/javascripts/jquery.tweet-408e79928ca077df30b72fe36df5754e.js" type="text/javascript"></script> <script src="/javascripts/twitter-options-084da5e02b1a45f2ea5ec905be775075.js" type="text/javascript"></script> <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-70134374-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script> <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> </head> <body> <header role="banner"><hgroup> <h1><a href="/">u-ryo's blog</a></h1> <h2>various information for coding...</h2> </hgroup> </header> <nav role="navigation"><ul class="subscription" data-subscription="rss "> <li><a href="http://u-ryo.github.io//atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> </ul> <form action="http://google.com/search" method="get"> <fieldset role="search"> <input type="hidden" name="sitesearch" value="http://u-ryo.github.io/"/> <input class="search" type="text" name="q" results="0" placeholder="Search"/> </fieldset> </form> <ul class="main-navigation"> <li><a href="/">Blog</a></li> <li><a href="/archives/">Archives</a></li> </ul> </nav> <div id="main"> <div id="content"> <div class="blog-index"> <article> <article> <header> <h1 class="entry-title"><a href="/blog/2020/12/23/cut-pdf-and-convert-to-png/">Cut Pdf and Convert to Png</a></h1> <p class="meta"> <time datetime="2020-12-23T01:07:00+09:00" pubdate data-updated=true> <span class="month">Dec</span> <span class="day">23</span>, <span class="year">2020</span> </time> | <a href="http://u-ryo.github.io//blog/2020/12/23/cut-pdf-and-convert-to-png/#disqus_thread">Comments</a> </p> </header> <div class="entry-content"><p>「pdf fileの10ページ目を切り取ってpngにconvertする」やり方。 <code>pdftk</code>で<code>10</code>ページ目を<code>cat</code>して標準出力に渡し、それをpipeで繋げて<code>pdftoppm</code>で標準入力から読み込みredirectして<code>-png</code>で変換してfileへ。<code>-png</code>がないと<code>.ppm</code>になるので注意。 <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>pdftk nenga2021.pdf cat 10 output -|pdftoppm -png - &gt; nenga2021.png
</span></code></pre></td></tr></table></div></figure></p> </div> </article> <article> <header> <h1 class="entry-title"><a href="/blog/2020/03/15/learned-on-ruby-and-vue-angularjs/">Learned on Ruby and Vue, Angularjs</a></h1> <p class="meta"> <time datetime="2020-03-15T21:15:00+09:00" pubdate data-updated=true> <span class="month">Mar</span> <span class="day">15</span>, <span class="year">2020</span> </time> | <a href="http://u-ryo.github.io//blog/2020/03/15/learned-on-ruby-and-vue-angularjs/#disqus_thread">Comments</a> </p> </header> <div class="entry-content"><p>お仕事でRuby on RailsとVueをやっております。 これまではずっとJavaやAngularな人生だったので、Duck Typingと格闘中です。 新規機能開発で様々な山を超えてきた(知見を得た)ので、忘れないうちに。</p> <ul> <li>破壊的method(Bang Method)って、その響きから何かあんまり良くないのかと無意識に思っていたのですけれども、調べてみると特に忌避すべきというものは見つかりませんでした。内部logicを考えると中で変数を付け替えていると思われますが、bangしないと両方分memoryに持ってなきゃならないから?→そうしたらrubocopに、<code>result[:key]=... if ...</code>と書けと言われました。ナルホドです!</li> <li>手元では<code>yarn test:vue</code>通るのにCircleCIでは<code>7 fails</code>と言われて通らないので悩みました。どう目を凝らしてもerrorらしき出力はなく。よく見るとCircleCIの最後に<code>Too long with no output (exceeded 10m0s): context deadline exceeded</code>とあり、かかった時間が10:57とか。えー!?そんなにかかっているの?? 手元で<code>time</code>で計測するも、1分ちょっと。CircleCI再実行して観察すると、test自体は1分程で終わり、その後ずっとだんまりで、10分程してTimeoutします。何だろう? 手元では再現しないのでとにかく厄介です。考えてみたら、チェックじゃなくて「1)」とか「2)」になっているところが失敗したところなんですね。確かに7)までありますわ。でも、そこがどう間違っているのかが全然出力されないので皆目わかりません。一箇所、<code>describe('...', async () =&gt; {</code>ってなっていたから、これか! と消して勇躍試してみたものの、症状変わらず。<code>mount</code>を<code>shallow</code>にしてみたり削れるだけの<code>async</code>/<code>await</code>を削っても。何故か<code>describe</code>の囲みを解くとtestが失敗します。期待してるobjectのpropsがないと。でももう一つ別のpropsはある。もぅわけわかんない!ですよ。CircleCIにsshで入ったりして色々と調べてみると、特定の2 filesが先にあると失敗する様子。何それ。どちらかがない、もしくはどちらかより先に実行されれば上手く行く。もっと詳しく見てみると、具体的には、<code>shallow</code>した直後の<code>wrapper.html()</code>の中身が全然違うという。どうして? そんなとこどうにもなんないじゃん。...あぁ、ぃゃ、test対象Vue Classできちんとcomponentを定義すると(e.g.<code>components: { 'el-button': Button, 'el-dialog': Dialog }</code>)warningが消えてcomponentとして見えるようになることがありますが(特にElementUIは<code>el-...</code>とclass nameが合わないので...(- -;)、そういうわけでもなく。何せ2 filesが組み合わさるとtestにコケるというのが謎です。試しにダメにするspec fileを一つ消してから全体的に<code>npm run test:vue</code>してみると、またコケるので、その2 filesはat leastであってもっと他にも組み合わせの悪いのがあるということです。i18nかなぁ? 確かに一方はenで他方はjaでしたが、大して使ってないのでcomment outしても変わらないですし... localでは全体的に通しても通っている、CircleCI上でも単体や相性の悪いものの後でなければ動く、でも全体的に通すとtestに失敗する、というのはとても悔しく、厄介です。結局心折れて、componentが見つからなければtest codeをthroughするようにしました。端から<code>describe.skip(...</code>よりはマシでしょう。それにしても何でやねん。大したtestしてるわけでもないclasses(methodがcallされたかどうかをassertしてる程度)に阻まれて、ちゃんと作ったspecのtest(条件がどうならどういう表示状態、<code>input</code>要素をclickしたらどういう文言のdialogが出て、等)を実行できないというのは何とも残念でなりません。</li> <li>Vueのtest、ムズカシイです。child componentの扱い、ですね。何気なく使っているであろう<code>el-table</code>とか<code>el-dialog</code>、そのままだとそんなcomponent知らないよとwarningが出まくります(<code>[Vue warn]: Unknown custom element: &lt;el-table-column&gt; - did you register the component correctly? For recursive components, make sure to provide the "name" option.</code>)。<code>wrapper</code>からはHTML Tagとして扱えるので最後はそうするのですけど、出来ればちゃんとcomponentとして扱いたいところです(でないとtable等でdataをloopさせて表示を作るcodeだった時のdata部分がそっくりないのでtest出来ない)。spec classで<code>shallow</code>(or<code>mount</code>)する時に<code>stubs:</code>するのかと思ってた(前それで頑張った気がした)んですけどそうではなく、spec対象元classでちゃんと定義されていれば?、否、ElementUIなんかは丸っと読み込まれているのでいいのかなぁ?ともあれ、spec classで<code>localVue.use(Table)</code>とした<code>localVue</code>を<code>shallow</code>(or<code>mount</code>)時に読み込んでやる必要がありました。でそのcomponentを<code>find</code>して<code>.props()</code>して中身を<code>expect</code>していくという流れですね。最初は<code>console.log(wrapper.html())</code>で何が捕れるのかよく観察すると。でも上記のように、何かが変わるとすぐ取れるcomponentが変わるようなので、怖いです。その辺りの機微がよくわからないので...</li> <li>Vue testにおけるtickの待ち方。<code>it(..., async () =&gt; { ... await Vue.nextTick(); ...});</code> 2 ticks待たないと値が変わらないことも。</li> <li><code>wrapper.findAll('.cell')</code>で取って来た値はElement Objectなので、見た目上は空でも<code>expect(cell).to.be.empty</code>とは出来ません。<code>expect(cell.isEmpty()).to.be.true</code></li> <li>Vue componentって、初期値<code>props</code>と<code>data</code>は分けねばならない? 当初、<code>data</code>に初期値を渡そうとしてどうしても出来ず、途方に暮れました。<code>data</code>の初期値は<code>data</code>部に書いた最初に返す値でそれは何でもよく、tagの方で渡す値で上書きされるのかと思ったら違うんですね。では<code>data</code>ではなく<code>props</code>を使うのかと思うとそうでもなく、<code>props</code>を後から変更しようとすると怒られますし。Stackoverflowにあった解決策は、初期値<code>props</code>と<code>data</code>を使い分けること。無駄な変数増えて何だかなぁとは思いますれど、そういうもの?</li> <li><code>slot-scope</code>って、<code>="scope"</code>ではなく<code>={row}</code>とやればいいんですね。本で知りました。</li> <li><code>...mapGetters</code>がなかなか効かなくて苦労しました。<code>computed:</code>に入れる、storeのmodule構造に合わせて<code>module(file)名/method名</code>にする、とやったんですが、<code>undefined</code>って言われて。<code>store</code>経由で<code>this.store.value_name</code>とかってやると取れるのに。でも<a href="https://uncle-javascript.com/vuex-getters">State を直接参照せず、getter 経由で参照することを強く推奨する</a>というので頑張りました。一回は諦めたんですけど、その後retryしたらうまくいくように。結局どうしてうまくようになったのか、決め手が何だったのかよく分からずじまいです。</li> <li>確認dialogを出すというんですが、非同期のJavascript/Vueにあってはこれが意外とムズカシイです。確認dialogというからには処理を止めなければなりません。よくやるように「flagで表示を制御」ではmain処理止まらないんですよね。そもそもsleepだとて簡単には行かないですよねJavascriptで。とても苦労しました。<code>async</code>/<code>await</code>を導入してやっと止めました。要は「dialogを作っているところを<code>new Promise</code>でくるんで<code>return</code>、それを<code>await</code>、しているfunctionを<code>async</code>」ですかね。</li> <li>dialogって自分で<code>$destory()</code>出来るんですね。生成と削除は外からやらないとダメかな、と思っていた(ので<code>$emit</code>して親で受けて<code>dialog.$destory()</code>してた)んですけど、実際生成は外から<code>$mount()</code>呼ばないとならないですけど(<code>created:</code>や<code>mounted:</code>はcallbackですよね)、「ボタン押したら消滅」で自己<code>$destroy()</code>は出来るんですねやってみたら。いちいち面倒くさいけどやってみないとわからんもんですね。</li> <li>dialogを出す必要に迫られたんですけど、よくあるようにdialogを予めDOMに仕込んでflagでappear/disposeとするには、2階層上のVue componentに書かないと、loopで大量生産されてしまうことが判明。Vue component間は親との対話だったら<code>$emit</code>と、戻しは何だ??を使えば出来ますが、2階層上は面倒です。情報渡すだけならまだしも、その後の処理を孫でやるならdialogの結果を2階層戻してもらわないとならないですし、じゃぁ処理もgrandparentに渡す? 処理に必要な情報も渡さないとだし、grandparentで知らなくてもいいことを知らなきゃいけないなんて。ということで、何かないかなーと探すと、揮発性dialogというものが(<a href="https://speakerdeck.com/uhck/hui-fa-xing-falsegao-ikonponentowozuo-ruhua">揮発性の高いコンポーネントを作る話</a>)。探すと似たようなことしてる人割と多く。これを理解して、そのままではなく2 filesで済むようにして自分のにapplyするのも頭を使いました。これ結構いいような。Vueのdialogも一般的にこれでいいような。初からDOMについているのではなくって。</li> <li>既述のように、<code>await</code>もうまく行ってよし、じゃぁtestを書くぞ、と試したら、いきなりわけのわからないerrorに見舞われてそもそもtestが動かなくなってしまいました。なんでだろー?! 自分以前では確かに動いていたので、自分のせいです。でもどのfileが悪いとかも出て来ないのでまるで取っ掛かりがなく、途方に暮れました。error messageで検索すると、どうやらなんと<code>async</code>/<code>await</code>を使った場合に出る<code>bable</code>/<code>polyfill</code>系のerrorだとか。えー!! 折角苦労して<code>async</code>/<code>await</code>でdialog止めたのに! 代替手段なんて思い付かないよー! ということで、何とか突破すべく頑張りました。<code>babel</code>の線で色々と調べてみると、こうしたら直った、ああしたら、とか種々書いてあるんですね。新たなgem install以外は全部試しましたけど、うまく行かず。でも<a href="https://stackoverflow.com/questions/33527653/babel-6-regeneratorruntime-is-not-defined/">この記事</a>を参考にvueの<code>setup.js</code>冒頭に<code>require("babel-polifill");</code>と書いたら!! 動いてくれました!! 省みれば僅か1行の追加ですけど、この1行には数時間もの汗と涙が詰まっているのです。</li> <li>APIの試験をするのに、<code>curl</code>やPostmanを使うのはよくありますけど、cookieが何か長くてcopyが面倒だなーと思ったので、Chrome Developer toolのConsoleにて<code>fetch</code>でやる手法を。<code>fetch(｀/apis/endpoint/＄｛id｝｀,{method:method,credentials:'include',headers:{'X-CSRF-Token':token}}).then((response)=&gt;console.log(response))</code>とすればBrowserの持っている認証情報をそのまま使ってくれます。<code>credentials:'include'</code>が肝です。どうせ使い捨てcommandですから。</li> <li>Railsは自動的にCSRF対策がなされている、ということで、何してるんだろーと思いきや、session毎に予測困難な<code>X-CSRF-Token</code>が付くというものでした。request毎に違うものでなくてもいいのか? いいのか...予測困難なら...</li> <li>Railsの日付、Timezone気を付けないといけないのですけど(AWSはUTCなので)、<code>Time.current</code>や<code>Date.current</code>のように<code>.current</code> methodを使えばTimezoneを意識してくれる模様。<code>.now</code>より<code>.current</code>がということでやはり「ナウい」は死語ということですか。</li> <li>Ruby、共通処理は継承関係作って親クラスに、と思っていたんですけどそれってJava的発想? OOP的というか。RubyではむしろMixin? MixinってAOPかと思ってたんですけど。Duck Typingだからそもそもclass的には無関係でいいんですね。Java屋さんとしては何だかなぁと。</li> <li>Rubyのstream(<code>map</code>や<code>select</code>や<code>reject</code>や<code>each</code>等)、もうfoolproofとして<code>lazy...force</code>を付けるのがいいんじゃないか、と思ったんですけど、そうでもないんですねこれ!! ってかそもそもどうして<code>lazy</code>がdefaultじゃないんだろう? ってJava屋さんとしては思ってたんですけど、<a href="https://bugs.ruby-lang.org/issues/6183#note-2">銀の弾丸ではない</a>という話があって衝撃でした何を今更ですけど(古い話のようで今は<a href="http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-core/77130">多少performance上がった</a>そう)。というわけで、<code>lazy</code>は「省メモリ」か「後でかなりの数<code>take</code>することがわかっている場合」でないと効果なさそうなんですね。<a href="https://stackoverflow.com/questions/47653131/rubys-lazy-less-performant-than-allocating-huge-lists">元ネタ</a></li> <li>最近何か安易に大量のlogをslackに投げていたので、そうじゃないでしょ基本的にはlog fileでしょ、それもdefaultのfileでいいよね、ということで、<code>Logger.new(...)</code>ってやったんですけどどうして毎回file nameを指定しなきゃいけないのか、しかもfile名指定して<code>new</code>すると都度file作りやがる、のでappend modeでopenして、とかってやらないとならないの?! なんか面倒臭くね? と思ってたら、<code>Rails.logger</code>でいいんですね。なぁんだ。<code>@logger ||= Rails.logger</code></li> <li><code>controller</code>で最終的?に全てのerrorを拾うには<code>rescue_from error_class名, with: :method名</code>、事前validationを定義するには<code>before_action :method名</code></li> <li>決まった名前をclass methodにするか定数にするか、は、定数の方が良いようです。ref. <a href="https://stackoverflow.com/questions/15903835/class-method-vs-constant-in-ruby-rails">Class method vs constant in Ruby/Rails</a></li> <li>Rubyで「objectの同一性」とは、Javaと違って<code>==</code>、<code>eql?</code>、<code>hash</code>の3 methodあるんですね。うち<code>==</code>はArrayで、残る2つはSetで使われる模様。Arrayでは比較通るのにSetでは違うと判定され悩みました。Setではobject hashを取っているからなんですね。でも結局、<code>.to_json</code>すれば同一性methods定義しなくても行けました。何だかなぁですけどまぁunit testなのでいっかー。</li> <li>すっかり忘れてましたけど<code>routes</code>で<code>resources</code>を使えばendpoint定義をまとめられますね。path parameterも積極的に使うべきでしょう(その存在を強制できるので)。parameter nameは基本<code>id</code>ですけど変えられるんですね。</li> <li>ActiveRecordで、MySQLみたいに「あれば取得、なければ作る(recordも入れる)」なんてあるかなーと思ったら<code>.find_or_create_by</code>がありました。更にforeign key制約をつけて、その制約に反したらerrorにして欲しい場合は、<code>.find_or_create_by!</code>でした。</li> <li>RubyでVO(Value Object)を作るのは、どうしたらいいんですかね。<code>object = Struct.new(:variables, ...)</code>とobjectとして使えば良い、という記述があったので、今度試してみます。←ここでいうobjectってclasなんですね。</li> <li>RubyにもJavadocのようなcomment流儀あるんですね。<a href="http://yardoc.org">YARD</a>ですか。<code>@param [引数のクラス] 引数名 引数の説明</code>、<code>@return [戻り値のクラス] 戻り値の説明</code></li> <li>配列からhash mapを作る手法、色々ありますよね。よくある「<code>[key, value]</code>の配列の配列にしてから<code>.to_set</code>」はloopを2回回すので何だかなぁと思っていました。Rubyにもある<code>reduce(inject)</code>を使えば出来る!とあったのでやったのですけど、そうしたらrubocopに「そういう時は<code>each_with_object</code>を使え」と言われました。ナルホド、それなら確かにblockの最後に<code>hash</code>をreturnせずともよいわけですね! というわけで、<code>list.each_with_object({}){|value,hash|hash[key]=value}</code>、更に一気にhashのhashを作るには、<code>list.each_with_object(Hash.new{|hash,key|hash[key]={}){|value,hash|hash[key1][key2]=value}</code></li> <li>同様に、一気に<code>Set</code>を作るには、<code>list.each_with_object(Set.new){|value,set|set&lt;&lt;value}</code>の方が、最後に<code>.to_set</code>よりよいでしょう。</li> <li>reekに「<code>log.debug</code>を複数回使っているからまとめよ」と言われて弱りました。単純にまとめると、毎回引数を評価しちゃうじゃないですか。でもloggingなので遅延評価が必要でしょう。というわけで、blockを残せるようにmethod定義しました。<code>def debug(&amp;block) Rails.logger.debug(&amp;block); end</code>使う時は<code>debug{...}</code>です。</li> <li><code>rescue</code>で<code>=&gt; e</code>とせずとも<code>$!</code>でerrorを参照できるんですね。<code>rescue</code>で<code>retry</code>とすれば<code>begin</code>からまたやってくれるんですね! ただ、上限設けないとずっとretryし続けるので注意ですかね。</li> <li>Railsでmail送信は、configが終わっているのであとは、<code>ApplicationMailer</code>を継承したclassを作成、<code>app/views/class名/method名.html.haml</code>といったtemplateを用意、という感じでした。html mailだけだとspam判定されやすいとのことなので、<code>app/views/class名/method名.txt.erb</code>も用意しました。classのinstance fieldをmail template中で参照できます。</li> <li>ActiveRecordでの取得はなるべく<code>.pluck</code>にした方が速いし軽い、ということでそうしてますが、でもそうすると何のためのDTOなのかと。model定義の意義が少し薄れるような。modelがfatなのが悪い? <code>.pluck</code>でない場合はせめて<code>.select</code>で選択するfieldを減らしてやって生成されるobjectを少しでも軽くすると。ただActiveRecordからObjectを生成するcostが高いとのことなので、<code>.pluck</code>の方が推奨されています。...<code>.select</code>って、modelにないfieldもselectできるんですね。そしてdynamicにmethodが生えると。なんかそこまで行くと気持ち悪い気がするのは、やはりJava出身だから??</li> <li><code>yield</code>はよく使いました。<code>if block_given?</code>も併せて。</li> <li>instanceからclass variableへの参照は<code>instance.class::VARIABLE</code>でした。</li> <li>rspecで<code>allow(Rails).to receive(:logger).and_return(spy('logger'))</code>とするとloggingが一律空回しになります。</li> <li>method chainを<code>allow</code>するには<code>receive_message_chain</code>(e.g.<code>expect(SomeClass).to receive_message_chain(:joins, :distinct, :where, :pluck)</code>) <code>.with(...)</code>を複数書いても、それぞれのmethodの引数指定ではなく、最後の一つしか評価されていない?</li> <li>rspecで、違ったparameterで同じobjectのmethodをcallするのをstubするには、<code>allow(...).to receive(:same_method).with(...)</code>を並列で何度も書けばよいです。<code>with(...)</code>をmethod chainさせるとかではないんですね。</li> <li>rspecでinstance doubleに引数を連ねるとmethod stubになります。e.g. <code>double('user', id: 1)</code>→<code>user.id==1</code>(<code>double</code>の最初の引数は任意名)</li> <li>調べればすぐ出てくることではありますが、Railsのmigrationの<code>create_table</code>時にprimary keyを自動で出来る<code>id</code>以外にしたい場合は<code>create_table</code>の行に<code>primary_key: key名</code>と書きます。更にforeign key constraintを付け加えたい場合は、その下に<code>add_foreign_key :table名, :foreign_table名</code>と書けば大丈夫でした。</li> <li>RubyでTime format時、<code>.strftime('%X')</code>とすると一文字で<code>15:37:21</code>に、<code>.strftime('%F')</code>とすると<code>2020-03-01</code>になるので便利です。また、<code>.iso8601</code>とすると<code>T</code>を挟んでTimezone付きで<code>2020-03-01T15:39:10+09:00</code>というようにしてくれるのでこれも便利です。</li> <li><a href="https://daily.belltail.jp/?p=2035">嫁の顔忘れてもTimecop.returnは忘れないでねという話</a>にあるように、<code>Timecop.travel(Time.parse('2020/3/1 0:01:03')) do ... end</code>で囲うのはいいですね。<code>Timecop</code>も<code>.travel</code>(特定時刻にしてから時を刻む)と<code>.freeze</code>(特定時刻にして時を止める)では違うので注意です。</li> <li>Rubyで文字列の連結は<code>&lt;&lt;</code>が<a href="https://qiita.com/Kta-M/items/c7c2fb0b61b11d3a2c48">いいみたい</a>ですね。C++みたいですね。</li> <li>ActiveRecordでN+1問題を回避するには、なるべく<code>joins</code>した方が良いようです。が、図に乗って巨大tableをjoinするとそれはcostがでかいので、分割して引いた方がいいんでしょう。<code>joins</code>するにはmodelに<code>has_many</code>とかの関係が書いてないとダメでした。2つ先の関連も書けて、<code>has_many :second_table, through: :first_table</code>と<code>through:</code>で繋げられました。</li> <li>と思ったのは幻想でした。書けちゃいますけど、joinされたものはkeyで結びついたものではなく、雑に合わさったもので、<code>where</code>で引いてもそうでないものまでついてきていて、bugを引き起こしていました。ちゃんとやらないとダメですね。</li> <li>「ちゃんとやる」とは、<a href="https://qiita.com/TeruhisaFukumoto/items/007ad22cc170d297dbcc">Railsでモデルを4段階joinする方法で、もう一度理解するjoinsとmerge</a>にあるように、ActiveRecordの<code>joins</code>で繋ぐ時に<code>joins(first:[second: :third])</code>とすること。これでちゃんとjoinされました。</li> <li>controllerで、APIっぽくheaderだけ返して中身は不要という場合、<code>head :created</code>(201)とか<code>head :unauthorized</code>(401)と書けます。</li> <li>Rubyのhere documentはもう<code>&lt;&lt;~</code>でよくないすか? <code>&lt;&lt;</code>だと左端にひっつくので。</li> <li>Rubyの<code>reduce</code>は<code>each_with_object</code>に取って代わられるのですが、<code>reduce(&amp;:method)</code>で済むところに活路があるようです。使えたのは<code>Set</code>のmergeですね。<code>[Set.new([1,2,3]),Set.new([2,3,4])].reduce(&amp;:merge)==Set.new([1,2,3,4])</code></li> <li>複数回<code>.include?</code>するなら絶対<code>Set</code>にすべきですよ。</li> <li>定数文字列もなるべく<code>.freeze</code>すべきでしょうか。magic comment <code># frozen_string_literal: true</code>で(が?)よいのでしょうか。</li> <li>controllerのrspecで、<code>before_action</code>のtestを書くことになったのですが、色々と悩みました。どこに書くか? 書いたclass? 使うclass? Javaでabstract classのtestだとconcrete classに書きますが、controllerは使う側に書くと多岐にわたるので、<code>application_controller_spec.rb</code>に書きました。</li> <li>curlでtest clientとしてJSONを<code>-d</code>でPOSTしたところ、どうもうまく行かなくて、調べるとserver側に<code>"{\"key\":\"value\"}"</code>なんて渡っていました。どうしてー?! HTTP Request Headerに<code>Contetnt-Type: application/json</code>が必要なんですね! そういえば。</li> <li>今更ですがAngularJSのtestで、<code>window.location.href</code>をassertionしようとして四苦八苦しました。<a href="https://stackoverflow.com/questions/20252382/how-to-mock-window-location-replace-in-angularjs-unit-test">How to mock $window.location.replace in AngularJS unit test?</a>等から得たことは、<code>window.location.href</code>だとtest(jasmin)で拾えないので<code>$window.location.href</code>にする、responseがemptyだとどうしてもtestの方でcatchしてくれないのでdummy値を<code>response</code>代入する、testでは<code>$window</code>がemptyで悩みました。<code>$provide.value('$window',</code>でprovideして<code>beforeEach(inject(function($injector, $rootScope, $httpBackend, $window) {</code>でinjectしつつ<code>window=$window;</code>と付け替えて、assertionのところで<code>window</code>を使う、という。</li> <li><code>diff</code>で相違は出ますが、共通行を抽出するには? <code>comm -1 -2 file1 file2</code>(但しfilesはsort済であること) ref.<a href="https://qiita.com/mekagazira/items/1a1791a42e435cefd5f6">２つのファイルの共通行を抽出する方法</a></li> <li>MySQLでindexがついたかどうかを確認するには、<code>describe table名</code>では<code>Mul</code>と付くだけでよくわからず。<code>show create table table名</code>でCREATE文を出すことで。</li> <li>controllerのrspecで、sessionってどう表すのかと。<code>get :index,params:{aaa:'AA'}</code>だから<code>get :index,params{...},session:{...}</code>かと思いきや、実際そう書いてあるところもあるんですが、それではうまく行かず、<code>get :index,{param:'something'},{session:'something'}</code>と。ref. <a href="https://stackoverflow.com/questions/22451969/rspec-set-session-object">RSpec set session object</a></li> <li>rspecでprivate variableにsetするには、<code>some_instance.instance_variable_set('variable_name', 'some value')</code>、getするには`some<em>instance.instance</em>variable<em>get('variable</em>name')</li> <li>visitor patternを適用しようと思っていたのですけど、諦めました。RubyってDuck Typingだからあんまり効果を見出だせず。<a href="https://passingloop.tumblr.com/post/13835569972/rarely-used-visitor-pattern-in-ruby">Ruby で Visitor パターンをあまり使わない理由，Ruby で Visitor パターンを使うとき</a>という投稿もあり。</li> </ul> <hr/> <ul> <li><p><a href="https://abicky.net/2018/12/03/104228/">upstart で start した job の設定を変更するには一度 stop する必要がある</a> へーそうなんだ! ってぃぅか何のための<code>restart</code>っすか? <code>restart</code>あるんだから機能すると思いますよねぇ...orz</p> </li> <li><p><code>1.hour.ago</code>があるのに<code>.later</code>や<code>.after</code>はないのでどうするんだろう? と思ったら、<code>1.hour.from_now</code>っていうんですね。</p> </li> <li><p>controllerのrspec書いていて、やっと単体で通るようになったので、いざ全体的にrspecかけてみると、コケます。確かに自分の書き足したところ。でも通る時もある。どうして?→そういう、rspecの結果が不安定な時は、実行順序依存性があります。これを紐解かねばなりません。それが厄介でした。といいますか、rspecって全体的にかけると、といいますかspec fileを指定しないでdirectoryだけ指定して実行すると、spec filesの実行順序がrandomなんですね。それはその方がいいですね。なので、色んな手を使って順序依存性を解明していきます。ref. <a href="https://qiita.com/ShunjiKato/items/c95e6cb0fb3523aa693a">RSpecコマンドのオプションまとめ</a> rspecに<code>--order random:NNNNN</code>を付けてrandom seedを固定、<code>-f d</code>として出力formatにclass名を出すようにし、<code>--no-color</code>でescape sequenceを抑制します。<code>-o filename.log</code>でfileに出力、それをうまく行ったときと失敗した時で保存して、class名を比較しました。当該classのtest以前だけが大事なので、そこだけ出して<code>sort</code>して<code>diff</code>取ります。失敗事例が複数取れれば、それらの共通classを<code>comm -1 -2 &lt;(...) &lt;(...)</code>で抽出するのが良いです。 <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>docker-compose <span class="nb">exec </span>rails bash -c <span class="s1">&#39;RAILS_ENV=test bundle exec rspec --order random:32510 -f d -o 32510.log --no-color&#39;</span>
</span><span class='line'>diff &lt;<span class="o">(</span>grep -e <span class="s1">&#39;^[A-Za-z]&#39;</span> -e <span class="s1">&#39;^  Apis::&#39;</span> controllers2.log|awk <span class="s1">&#39;{if(/ApplicationController/){exit}print}&#39;</span>|sort<span class="o">)</span> &lt;<span class="o">(</span>grep -e <span class="s1">&#39;^[A-Za-z]&#39;</span> -e <span class="s1">&#39;^  Apis::&#39;</span> 32510.log|awk <span class="s1">&#39;{if(/ApplicationController/){exit}print}&#39;</span>|sort<span class="o">)</span>|ag <span class="s1">&#39;&lt;&#39;</span>
</span><span class='line'>comm -1 -2 &lt;<span class="o">(</span>grep -e <span class="s1">&#39;^[A-Za-z]&#39;</span> -e <span class="s1">&#39;^  Apis::&#39;</span> controllers2.log|awk <span class="s1">&#39;{if(/ApplicationController/){exit}print}&#39;</span>|sort<span class="o">)</span> &lt;<span class="o">(</span>grep -e <span class="s1">&#39;^[A-Za-z]&#39;</span> -e <span class="s1">&#39;^  Apis::&#39;</span> 4627.log|awk <span class="s1">&#39;{if(/ApplicationController/){exit}print}&#39;</span>|sort<span class="o">)</span>
</span><span class='line'>comm -1 -2 &lt;<span class="o">(</span>grep -e <span class="s1">&#39;^[A-Za-z]&#39;</span> -e <span class="s1">&#39;^  Apis::&#39;</span> controllers2.log|awk <span class="s1">&#39;{if(/ApplicationController/){exit}print}&#39;</span>|sort<span class="o">)</span> &lt;<span class="o">(</span>grep -e <span class="s1">&#39;^[A-Za-z]&#39;</span> -e <span class="s1">&#39;^  Apis::&#39;</span> 48327.log|awk <span class="s1">&#39;{if(/ApplicationController/){exit}print}&#39;</span>|sort<span class="o">)</span>|grep -r -l -f /dev/stdin spec/controllers|sort -u|tr -d <span class="s1">&#39;\r&#39;</span>
</span></code></pre></td></tr></table></div></figure></p> </li> <li><p>単体では通るのに全体だと時々こけるというのはどうしてもよくわからないので、何度も何度も実行して観察してみると、コケる時のFの出る位置がまちまちなんですね。あぁ、これって毎回test順序違うのか、とその時初めて思い至りました。それで、rspecにおけるrandom seedの固定方法や出力形式の指定の仕方を調べ、何とか実行順を成功時と失敗時で比較して、怪しいものを試して、辿り着いたのでした。</p> </li> <li><p>controllerのtestでは、<code>before_action</code>に指定したprivate methodのtest且つ利用するchild classでのtestではなくbase classでのtestなので、当初は<code>contorller.send('method_name')</code>とかやってたんですけどこれは本来的ではないな、ということで、Anonymous Controller使いました。といっても<code>describe</code>の中で<code>controller do ... end</code>して、そこで<code>before_action :method_name</code>しただけのものです。それでその<code>describe</code>内のcontrollerは定義したものになるという、お手軽な。でもここでエラー(<code>Error</code>をthrow、じゃないRubyだからraiseですか、する筈が正常に終了してしまう)が出て、悩みました。結局、わかってみればどうということはないのですが、他のspec classで、<code>ApplicationController.skip_before_filter :login_required</code>を<code>before do...</code>でやっていて、でも<code>after do...</code>で元に戻していなかったから、というのが原因でした。</p> </li> <li><p>そもそも、<code>ApplicationController.skip_before_filter</code>なんてせずに、単に<code>allow(controller).to receive(:method)</code>とmockすれば十分です。そうしたら<code>after do...</code>だって不要ですし。ref. <a href="https://qiita.com/yuutetu/items/a1586339d716aad04098">before_filterを分離してテストする方法(Rspec)</a> 別段<code>true</code>返す必要もないんですねこの<code>before_action</code>って。<code>before_filter</code>は古いんだそう。</p> </li> <li><p>いつも<code>schedule</code>の確認をするのに。<code>bundle exec whenever</code></p> </li> <li><p>AngularJSでのredirect? になるのかな? は、routesの<code>$stateProvider.state('...')</code>に定義されたところへ、<code>$state.go('...')</code>で飛びます。ref. <a href="https://qiita.com/nogson/items/63d8f007fe987e2dfe9e">Angularjs UI Routerの使い方</a> でも結局、AngularJSのrouting範囲外に飛ばしたかったので、<code>$window.location.href = ...</code>で飛ばしました。</p> </li> <li><p>ActiveRecordの<code>scope</code>に引数を取る場合には、<code>scope scope_name -&gt;(arg1, arg2) { ... }</code> 矢印とカッコはくっつけないとreekに怒られます。</p> </li> <li><p>Rubyで<code>String</code>の<code>select</code>を正規表現でするなら<code>grep(/.../)</code>、<code>-v</code>の場合は<code>grep_v</code>(<a href="https://stackoverflow.com/questions/4165971/ruby-equivalent-to-grep-v/33881808">Ruby equivalent to grep -v</a>)</p> </li> <li><p>AngularJSのroutingってURLについたanchor(<code>#</code>以下)に出るのですが、それってそもそもbrowserがserver側に送信しないんですね...</p> </li> <li><p>ActiveRecordで選択して保存を1行で。例えば<code>User.find(1).update(name:'new name')</code></p> </li> <li><p>rspecでActiveRecordのtest dataってfixtureやFactoryGirlを使うものかと思っていたのですけど、普通に<code>.create</code>とか<code>.update</code>とかして大丈夫なんですね。大丈夫、というのは、後腐れがない、んですね。</p> </li> <li><p>RSpecで<code>allow</code>でmockした時に、<code>.and_return</code>だけでなく処理(<code>sleep(1)</code>)を入れたかったんですけどどうしたら? と思ったら、単にblockでいいんですね。blockの最終評価値がreturnになる、というなら<code>.and_return</code>って不要なの?</p> </li> </ul> </div> </article> <article> <header> <h1 class="entry-title"><a href="/blog/2020/01/12/add-swap-file/">Add Swap File</a></h1> <p class="meta"> <time datetime="2020-01-12T01:19:00+09:00" pubdate data-updated=true> <span class="month">Jan</span> <span class="day">12</span>, <span class="year">2020</span> </time> | <a href="http://u-ryo.github.io//blog/2020/01/12/add-swap-file/#disqus_thread">Comments</a> </p> </header> <div class="entry-content"><p>年末にideapad 310のmemoryが壊れてしまい、2度買い直してもmemoryを認識しなかったので、これは本体側が壊れたのだろうと。これを直すには本体のmother board交換になる、くらいならまだ2年程しか使ってませんが新しいのを買う? と考え、物色していたところ、新しいものでもmemoryって搭載容量4GBとか程度で、何故? と思ったんですけど、今はSSDだからそれでいいってことなんですね! そっか、今はSSDが廉価になったからswapでいいのか! なら310もSSDに換装すれば、ということで、SSD 1TBにしました。1.11万円でSamsungの1TBをGET。ubuntu 19.10を入れて... 最初、折角だからZFSにしてみたのですが、SSDと相性悪いんですねこれ。swap partitionは、位置が固定されるためSSDには良くないと。XFSもSSDではjournalingを止めた方が良いとのことで、それだと何のためのXFSなの?! ということなのでつまらないですけどext4で再installします。しかし、partitioningをお任せにすると、今はdefaultでswap partitionではなく2GBのswap fileになるというのは驚きですね。 ということで、本題です。よく、<code>dd</code>でswap fileを作る例が載っていますけれども、<a href="https://www.server-memo.net/centos-settings/system/add-swap.html#ext4">スワップ領域の追加方法|server-memo.net</a>には<code>fallocate</code>を使う方法があったので、メモです。</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo fallocate -l 2G /swapfile1
</span><span class='line'>sudo mkswap /swapfile1
</span><span class='line'>Setting up swapspace version 1, <span class="nv">size</span> <span class="o">=</span> 2097148 KiB
</span><span class='line'>no label, <span class="nv">UUID</span><span class="o">=</span>89a19a54-42c9-4847-a482-1971c388fa95
</span><span class='line'>sudo chmod 600 /swapfile1
</span><span class='line'>sudo swapon /swapfile1
</span></code></pre></td></tr></table></div></figure> </div> </article> <article> <header> <h1 class="entry-title"><a href="/blog/2019/06/02/google-photo-api/">Google Photo Api</a></h1> <p class="meta"> <time datetime="2019-06-02T03:49:00+09:00" pubdate data-updated=true> <span class="month">Jun</span> <span class="day">02</span>, <span class="year">2019</span> </time> | <a href="http://u-ryo.github.io//blog/2019/06/02/google-photo-api/#disqus_thread">Comments</a> </p> </header> <div class="entry-content"><p>一日千枚とか写真撮る人だと写真がすぐ溜まっちゃうんですよね。 backupは無限の<a href="https://photos.google.com">Google Photos</a>に、ということで、前はPicasaのAPI、<code>upload_gphots</code>を使ってたんですけど、もう無くなっちゃっていて。どうしよう、途方に暮れていました。暫くぶりに探すと、丁度1年程前からGoogle Photo APIが整備されたようで、良かったです。ずっと待っていました。 <a href="https://qiita.com/zaki-lknr/items/97c363c12ede4c1f25d2">[追記あり] Google Photos APIsでアルバム作成と写真のアップロード</a>と<a href="https://qiita.com/wo_k_harada/items/7327971a2414040e5a86">Google Photoを業務システムのクラウドストレージとして使った結果</a>、<a href="https://developers.google.com/photos/library/guides/list">本家API Document</a>を参考に早速使ってみます。</p> <h2>ACCESS_TOKENの取得</h2> <ul> <li><a href="https://developers.google.com/photos/library/guides/get-started">APIの有効化</a></li> <li><a href="https://console.developers.google.com/">Google Developer Console</a>から「認証情報」→「OAuth2.0クライアントID」無ければ上の「認証情報を作成」pulldown menuから「OAuthクライアントID」(「ウェブアプリケーションの種類」は「その他」)で作成</li> <li>上記「クライアントID」「クライアント シークレット」をメモ</li> <li>次のURLに<code>$CLIENT_ID</code>を入れてbrowserでaccess、AUTHORIZATION_CODEを取得 (<code>https://accounts.google.com/o/oauth2/v2/auth?response_type=code&amp;client_id=$CLIENT_ID&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;scope=https://www.googleapis.com/auth/photoslibrary&amp;access_type=offline</code> (SCOPEはGoogle PhotoでのR/W accessの場合は<code>https://www.googleapis.com/auth/photoslibrary</code>)</li> <li>以下のようにして、<code>ACCESS_TOKEN</code>及び<code>REFRESH_TOKEN</code>を得る <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ AUTHORIZATION_CODE</span><span class="o">=</span>4/wnmGpTh__1zdrgdjmPWyetUI7C1mvsjRrA_IyZmwY7aSeYppD9X_9iB
</span><span class='line'><span class="nv">$ CLIENT_ID</span><span class="o">=</span>952391557281-s8b8ditnocfu590fi0ntsfk76rbmkm80.apps.googleusercontent.com
</span><span class='line'><span class="nv">$ CLIENT_SECRET</span><span class="o">=</span>k6XPLuryMWUtKDKmS1cYgW0r
</span><span class='line'><span class="nv">$ REDIRECT_URI</span><span class="o">=</span>urn:ietf:wg:oauth:2.0:oob
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl --data <span class="s2">&quot;code=$AUTHORIZATION_CODE&quot;</span> --data <span class="s2">&quot;client_id=$CLIENT_ID&quot;</span> --data <span class="s2">&quot;client_secret=$CLIENT_SECRET&quot;</span> --data <span class="s2">&quot;redirect_uri=$REDIRECT_URI&quot;</span> --data <span class="s2">&quot;grant_type=authorization_code&quot;</span> --data <span class="s2">&quot;access_type=offline&quot;</span> https://www.googleapis.com/oauth2/v4/token
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;access_token&quot;</span>: <span class="s2">&quot;ya29.GlsOB-ebr6NrI78UemOPHcm1-jdw0XkxD8iiSqE-Bh5xB_Sx8bhKsRhRyz7gqJy45A-HIF6s6GF0j5wz0dmNppVqEMhtUurAwfbe-xgEsR5MZFjoIY3ONOx8zd4Q&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;expires_in&quot;</span>: 3600,
</span><span class='line'>  <span class="s2">&quot;refresh_token&quot;</span>: <span class="s2">&quot;1/8LrGRLdBaFJYHlOr0rEAyZcgC9yDl2PcZZyrbqoxc7c&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;scope&quot;</span>: <span class="s2">&quot;https://www.googleapis.com/auth/photoslibrary&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;token_type&quot;</span>: <span class="s2">&quot;Bearer&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></li> <li><code>ACCESS_TOKEN</code>は1時間しか有効でないので、適宜<code>REFRESH_TOKEN</code>を使って更新 <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ REFRESH_TOKEN</span><span class="o">=</span>1/8LrGRLdBaFJYHlOr0rEAyZcgC9yDl2PcZZyrbqoxc7c
</span><span class='line'><span class="nv">$ CLIENT_ID</span><span class="o">=</span>952391557281-s8b8ditnocfu590fi0ntsfk76rbmkm80.apps.googleusercontent.com
</span><span class='line'><span class="nv">$ CLIENT_SECRET</span><span class="o">=</span>k6XPLuryMWUtKDKmS1cYgW0r
</span><span class='line'>
</span><span class='line'><span class="nv">$ ACCESS_TOKEN</span><span class="o">=</span><span class="sb">`</span>curl -s --data <span class="s2">&quot;refresh_token=$REFRESH_TOKEN&quot;</span> --data <span class="s2">&quot;client_id=$CLIENT_ID&quot;</span> --data <span class="s2">&quot;client_secret=$CLIENT_SECRET&quot;</span> --data <span class="s2">&quot;grant_type=refresh_token&quot;</span> https://www.googleapis.com/oauth2/v4/token|jq .access_token -r<span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure></li> </ul> <p><code>REFRESH_TOKEN</code>を取得すれば、あと<code>CLIENT_ID</code>と<code>CLIENT_SECRET</code>が分かれば<code>ACCESS_TOKEN</code>は更新できます。</p> <h2>ALBUMの作成</h2> <ul> <li>既存のAlbumの確認 <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>curl -s -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> https://photoslibrary.googleapis.com/v1/albums?pageSize<span class="o">=</span>50
</span></code></pre></td></tr></table></div></figure></li> <li>既存のAlbumの確認(<code>nextPageToken</code>がある場合) <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>curl -s -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> https://photoslibrary.googleapis.com/v1/albums?pageSize<span class="o">=</span>50&amp;pageToken<span class="o">=</span>...
</span></code></pre></td></tr></table></div></figure></li> <li>新規Albumの作成 <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ DIR</span><span class="o">=</span>20190428
</span><span class='line'><span class="nv">$ </span>curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{ &quot;album&quot;: { &quot;title&quot;:&quot;&#39;</span><span class="nv">$DIR</span><span class="s1">&#39;&quot; } }&#39;</span> https://photoslibrary.googleapis.com/v1/albums
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;ADIlBkAOcfB64a_Opnwdjgxeq6jhQv4GQ1pZQ-wse2o2hiBIofuhefmFycfTtIcLAG0inLt0FlZn&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;20190428&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;productUrl&quot;</span>: <span class="s2">&quot;https://photos.google.com/lr/album/ADIlBkAOcfB64a_Opnwdjgxeq6jhQv4GQ1pZQ-wse2o2hiBIofuhefmFycfTtIcLAG0inLt0FlZn&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;isWriteable&quot;</span>: <span class="nb">true</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></li> </ul> <h2>UPLOAD and adding to Album</h2> <p>2段階になっていて、</p> <ol> <li>binary fileをuploadして<code>UPLOAD_TOKEN</code>を得る</li> <li><code>UPLOAD_TOKEN</code>を元に<code>mediaItems:batchCreate</code>する(ALBUM名はここで渡す。batch処理なので複数の<code>UPLOAD_TOKEN</code>を渡せる)</li> </ol> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">FILENAME</span><span class="o">=</span>20190428/img_0699.jpg
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s1">&#39;Content-type: application/octet-stream&#39;</span> -H <span class="s1">&#39;X-Goog-Upload-Protocol: raw&#39;</span> -H <span class="s2">&quot;X-Goog-Upload-File-Name: $FILENAME&quot;</span> --data-binary <span class="s2">&quot;@$FILENAME&quot;</span> https://photoslibrary.googleapis.com/v1/uploads
</span><span class='line'>CAIS+QIASsy4zFbu3IKGgbDXA5XshOGvHPOTLuqbqTN9MQxKRVCsxp3YHbus+qsDgA0GCjuqXdmGpv1uWFxKvf8GYa/8VJQ1S6FUcmGWgw6Hdj14QNYtBRVbXU/cdq/Jkx3ZblG5co3hnY6+yMxih26kB0vTWfWp9GwIE904y5yXEE1pm/V0bFduzA/CZvdlAU9EvWfqKnNO7c3nozWUalm5WUZHHatVQZT+H5+jD0Bq3YwMUdfC5KF048AxFa9auW1HpQGdboalYyXBCJksfzteWtU53wZ8rFnZgHwrui9uA2ptnTuDlin2m+WXU+HqaVRuKX1ou5BzalI4P0gVfWql41Af6nuvvEdMNZ39tEvK2EARUX0CUd8veDznZiWjtPcRqpJnvjDRCxaSgr/cn+JXf9k7SnD0DYVWOdM64lngcAuXxsKk6RJJOVxQBUi6XAG04dHnKxDndqjl+fcH9qWAmpXejPx8Kgn6GX7TgatiKHEG4ybvWjStWg1JPg
</span><span class='line'>
</span><span class='line'><span class="nv">$ UPLOAD_TOKEN</span><span class="o">=</span>CAIS+...
</span><span class='line'><span class="nv">$ ALBUM_ID</span><span class="o">=</span>ADIlBkAOcfB64a_Opnwdjgxeq6jhQv4GQ1pZQ-wse2o2hiBIofuhefmFycfTtIcLAG0inLt0FlZn
</span><span class='line'><span class="nv">$ </span>curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{ &quot;albumId&quot;: &quot;&#39;</span><span class="nv">$ALBUM_ID</span><span class="s1">&#39;&quot;, &quot;newMediaItems&quot;:[ { &quot;simpleMediaItem&quot;: { &quot;uploadToken&quot;: &quot;&#39;</span><span class="nv">$UPLOAD_TOKEN</span><span class="s1">&#39;&quot; }} ] }&#39;</span> https://photoslibrary.googleapis.com/v1/mediaItems:batchCreate
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;newMediaItemResults&quot;</span>: <span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>      <span class="s2">&quot;uploadToken&quot;</span>: <span class="s2">&quot;CAIS+...&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;status&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;message&quot;</span>: <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>      <span class="o">}</span>,
</span><span class='line'>      <span class="s2">&quot;mediaItem&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;ADIl...&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;productUrl&quot;</span>: <span class="s2">&quot;https://photos.google.com/lr/album/ADIl...&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;mimeType&quot;</span>: <span class="s2">&quot;image/jpeg&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;mediaMetadata&quot;</span>: <span class="o">{</span>
</span><span class='line'>          <span class="s2">&quot;creationTime&quot;</span>: <span class="s2">&quot;2019-04-28T02:40:35Z&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;width&quot;</span>: <span class="s2">&quot;5184&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;height&quot;</span>: <span class="s2">&quot;3456&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;filename&quot;</span>: <span class="s2">&quot;20190428/img_0699.jpg&quot;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure> <h2>folderまるっとupload</h2> <ul> <li>事前準備 <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">REFRESH_TOKEN</span><span class="o">=</span>...
</span><span class='line'><span class="nv">CLIENT_ID</span><span class="o">=</span>...
</span><span class='line'><span class="nv">CLIENT_SECRET</span><span class="o">=</span>...
</span><span class='line'><span class="nv">ACCESS_TOKEN</span><span class="o">=</span><span class="sb">`</span>curl -s --data <span class="s2">&quot;refresh_token=$REFRESH_TOKEN&quot;</span> --data <span class="s2">&quot;client_id=$CLIENT_ID&quot;</span> --data <span class="s2">&quot;client_secret=$CLIENT_SECRET&quot;</span> --data <span class="s2">&quot;grant_type=refresh_token&quot;</span> https://www.googleapis.com/oauth2/v4/token|jq .access_token -r<span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure></li> <li>Album作成 <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">DIR</span><span class="o">=</span>...
</span><span class='line'><span class="nv">ALBUM_ID</span><span class="o">=</span><span class="sb">`</span>curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;album&quot;:{&quot;title&quot;:&quot;&#39;</span><span class="nv">$DIR</span><span class="s1">&#39;&quot;}}&#39;</span> https://photoslibrary.googleapis.com/v1/albums|jq -r .id<span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure></li> <li><code>~/photo/$DIR</code>以下の<code>img_*.jpg</code> filesのuploadとalbum登録(約100 files毎に<code>ACCESS_TOKEN</code>のrefresh)</li> </ul> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">for </span>i in ~/photo/<span class="nv">$DIR</span>/img_*.jpg; <span class="k">do if</span> <span class="o">[</span> ! <span class="k">${</span><span class="nv">i</span><span class="p">##*00.jpg</span><span class="k">}</span> <span class="o">]</span>;<span class="k">then </span><span class="nv">ACCESS_TOKEN</span><span class="o">=</span><span class="sb">`</span>curl -s --data <span class="s2">&quot;refresh_token=$REFRESH_TOKEN&quot;</span> --data <span class="s2">&quot;client_id=$CLIENT_ID&quot;</span> --data <span class="s2">&quot;client_secret=$CLIENT_SECRET&quot;</span> --data <span class="s2">&quot;grant_type=refresh_token&quot;</span> https://www.googleapis.com/oauth2/v4/token|jq .access_token -r<span class="sb">`</span>;<span class="k">fi</span>;<span class="nv">UPLOAD_TOKEN</span><span class="o">=</span><span class="sb">`</span><span class="nv">FILENAME</span><span class="o">=</span><span class="nv">$DIR</span>/<span class="k">${</span><span class="nv">i</span><span class="p">##*/</span><span class="k">}</span>; curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s1">&#39;Content-type: application/octet-stream&#39;</span> -H <span class="s1">&#39;X-Goog-Upload-Protocol: raw&#39;</span> -H <span class="s2">&quot;X-Goog-Upload-File-Name: $FILENAME&quot;</span> --data-binary <span class="s2">&quot;@$i&quot;</span> https://photoslibrary.googleapis.com/v1/uploads<span class="sb">`</span>;curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;albumId&quot;:&quot;&#39;</span><span class="nv">$ALBUM_ID</span><span class="s1">&#39;&quot;,&quot;newMediaItems&quot;:[{&quot;simpleMediaItem&quot;:{&quot;uploadToken&quot;:&quot;&#39;</span><span class="nv">$UPLOAD_TOKEN</span><span class="s1">&#39;&quot;}}]}&#39;</span> https://photoslibrary.googleapis.com/v1/mediaItems:batchCreate|tee -a /tmp/upload.log|grep -q error&amp;&amp;echo <span class="nv">$i</span>;<span class="k">done</span>|tee /tmp/upload_failed.log
</span></code></pre></td></tr></table></div></figure> <p>uploadに失敗したfile namesが標準出力と<code>/tmp/upload_failed.log</code>に出てくるので、後刻それらをretry。</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">for </span>i in <span class="sb">`</span>cat /tmp/upload_failed.log<span class="sb">`</span>; <span class="k">do if</span> <span class="o">[</span> ! <span class="k">${</span><span class="nv">i</span><span class="p">##*00.jpg</span><span class="k">}</span> <span class="o">]</span>;<span class="k">then </span><span class="nv">ACCESS_TOKEN</span><span class="o">=</span><span class="sb">`</span>curl -s --data <span class="s2">&quot;refresh_token=$REFRESH_TOKEN&quot;</span> --data <span class="s2">&quot;client_id=$CLIENT_ID&quot;</span> --data <span class="s2">&quot;client_secret=$CLIENT_SECRET&quot;</span> --data <span class="s2">&quot;grant_type=refresh_token&quot;</span> https://www.googleapis.com/oauth2/v4/token|jq .access_token -r<span class="sb">`</span>;<span class="k">fi</span>;<span class="nv">UPLOAD_TOKEN</span><span class="o">=</span><span class="sb">`</span><span class="nv">FILENAME</span><span class="o">=</span><span class="nv">$DIR</span>/<span class="k">${</span><span class="nv">i</span><span class="p">##*/</span><span class="k">}</span>; curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s1">&#39;Content-type: application/octet-stream&#39;</span> -H <span class="s1">&#39;X-Goog-Upload-Protocol: raw&#39;</span> -H <span class="s2">&quot;X-Goog-Upload-File-Name: $FILENAME&quot;</span> --data-binary <span class="s2">&quot;@$i&quot;</span> https://photoslibrary.googleapis.com/v1/uploads<span class="sb">`</span>;curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;albumId&quot;:&quot;&#39;</span><span class="nv">$ALBUM_ID</span><span class="s1">&#39;&quot;,&quot;newMediaItems&quot;:[{&quot;simpleMediaItem&quot;:{&quot;uploadToken&quot;:&quot;&#39;</span><span class="nv">$UPLOAD_TOKEN</span><span class="s1">&#39;&quot;}}]}&#39;</span> https://photoslibrary.googleapis.com/v1/mediaItems:batchCreate|tee -a /tmp/upload.log|grep -q error&amp;&amp;echo <span class="nv">$i</span>;<span class="k">done</span>
</span></code></pre></td></tr></table></div></figure> <p>これではbatch処理を活かしていない(複数の<code>UPLOAD_TOKEN</code>をbatchCreateしていない)のですが、Googleだけに割とすぐ終わること、error handlingがあまりにも複雑になることから、都度batchCreateすることにしました。</p> <p>私の場合、1000 filesで約3GB弱、を目処に分割してuploadしています。 uploadしたfilesは全て「元のサイズ」で保存されてしまい、Google Driveの容量を消費してしまうので、<a href="https://photos.google.com/settings">設定</a>から「容量を解放」しなければなりません。これが「1日1回」となっているものの、だからといって24時間後に再度実行しても「ファイルを圧縮できませんでした。ストレージを復元できるのは 1 日 1 回だけです。」と言われて出来ず、困っています。実際に再度実行できるまでには1.5日〜2日かかるようで、これが最大のneckになっています。</p> <h2>新規Albumへの既存files追加</h2> <p>これはダメでした。 何度試してもダメだったので、調べてみると、公式Documentに、 <a href="https://developers.google.com/photos/library/guides/manage-albums">Note that you can only add media items that have been uploaded by your application to albums that your application has created.</a>とあります。 なんでやねん! 何で既存の画像とAPI経由の画像とを区別するのか、わけわかりません。 それじゃぁ、っていうんで、既にGoogle Photos上にある写真も改めてuploadしてalbumにaddしたら、それは出来ました。しかし、「元のサイズ」になってしまって容量を食ってしまいます。これについても「容量を解放」しなければなりません。 全く七面倒臭いものです。</p> <p>ちなみに、以下のようにやりました。paginationが発生しない程度のAlbum限定で、 <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ DIR</span><span class="o">=</span>20171005
</span><span class='line'><span class="nv">$ ALBUM_ID</span><span class="o">=</span><span class="sb">`</span>curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{ &quot;album&quot;: { &quot;title&quot;:&quot;&#39;</span><span class="nv">$DIR</span><span class="s1">&#39;&quot; } }&#39;</span> https://photoslibrary.googleapis.com/v1/albums|jq -r .id<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ MEDIA_ITEMS</span><span class="o">=</span><span class="sb">`</span>curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;pageSize&quot;:&quot;100&quot;,&quot;filters&quot;:{&quot;dateFilter&quot;:{&quot;dates&quot;:[{&quot;year&quot;:2017,&quot;month&quot;:10,&quot;day&quot;:5}]}}}&#39;</span> https://photoslibrary.googleapis.com/v1/mediaItems:search|jq .mediaItems<span class="o">[]</span>.id|sed -z <span class="s1">&#39;s/\n/,/g&#39;</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;mediaItemIds&quot;:[&#39;</span><span class="nv">$MEDIA_ITEMS</span><span class="s1">&#39;]}&#39;</span> https://photoslibrary.googleapis.com/v1/albums/<span class="k">${</span><span class="nv">ALBUM_ID</span><span class="k">}</span>:batchAddMediaItems
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;error&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;code&quot;</span>: 400,
</span><span class='line'>    <span class="s2">&quot;message&quot;</span>: <span class="s2">&quot;Request contains an invalid media item id.&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;status&quot;</span>: <span class="s2">&quot;INVALID_ARGUMENT&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure> なら既存のものは手でやればいいではないか? やってみたのですが、微妙に手元のfilesと数が合わなかったりするので、困難です。手元に3282枚あってGoogle PhotosのAlbumに3281枚あった時、どうやって差分をあぶり出したらいいのですか?! 全downloadはなしで。もう一つでは、手元に5221枚、Google Photosに5230枚と増えてます! Manuallyでは限界を感じました。</p> <h2>Album中の全file名取得</h2> <p>自己解決しました。 <code>NEXT_PAGE_TOKEN</code>あると面倒くさいんですけど、これで何とか。</p> <h3>Album探し</h3> <p>最初のpageに目的のalbumがあるかをこれ↓で探す</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -s -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> <span class="s1">&#39;https://photoslibrary.googleapis.com/v1/albums?pageSize=50&#39;</span>|jq -r .albums<span class="o">[]</span>.title,.nextPageToken
</span></code></pre></td></tr></table></div></figure> なければ次のpageへ。</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -s -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> <span class="s1">&#39;https://photoslibrary.googleapis.com/v1/albums?pageSize=50&amp;pageToken=Ck...&#39;</span>|jq -r .albums<span class="o">[]</span>.title,.nextPageToken
</span></code></pre></td></tr></table></div></figure> <p>見付かれば、<code>ALBUM_ID</code>を同定。</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl -s -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> <span class="s1">&#39;https://photoslibrary.googleapis.com/v1/albums?pageSize=50&amp;pageToken=Ck...&#39;</span>|grep -1 20080318
</span><span class='line'>      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;ADI...&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;20080318&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;productUrl&quot;</span>: <span class="s2">&quot;https://photos.google.com/lr/album/ADI...&quot;</span>,
</span></code></pre></td></tr></table></div></figure> <p>そうしてから徐に、 <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">ALBUM_ID</span><span class="o">=</span>...
</span><span class='line'><span class="nv">NEXT_PAGE_TOKEN</span><span class="o">=</span><span class="sb">`</span>curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;pageSize&quot;:&quot;100&quot;,&quot;albumId&quot;:&quot;&#39;</span><span class="nv">$ALBUM_ID</span><span class="s1">&#39;&quot;}&#39;</span> https://photoslibrary.googleapis.com/v1/mediaItems:search|jq -r <span class="s1">&#39;.mediaItems[].filename,.nextPageToken&#39;</span>|tee /tmp/files.txt|tail -1<span class="sb">`</span>;<span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;$NEXT_PAGE_TOKEN&quot;</span> !<span class="o">=</span> null <span class="o">]</span>;<span class="k">do </span><span class="nv">NEXT_PAGE_TOKEN</span><span class="o">=</span><span class="sb">`</span>curl -s -X POST -H <span class="s2">&quot;Authorization: Bearer $ACCESS_TOKEN&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;pageSize&quot;:&quot;100&quot;,&quot;albumId&quot;:&quot;&#39;</span><span class="nv">$ALBUM_ID</span><span class="s1">&#39;&quot;,&quot;pageToken&quot;:&quot;&#39;</span><span class="nv">$NEXT_PAGE_TOKEN</span><span class="s1">&#39;&quot;}&#39;</span> https://photoslibrary.googleapis.com/v1/mediaItems:search|jq -r <span class="s1">&#39;.mediaItems[].filename,.nextPageToken&#39;</span>|tee -a /tmp/files.txt|tail -1<span class="sb">`</span>;<span class="k">done</span>
</span></code></pre></td></tr></table></div></figure> <p>その後、</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>grep -vE -e <span class="s1">&#39;.{300,}&#39;</span> -e null /tmp/files.txt
</span></code></pre></td></tr></table></div></figure> <p>で取り出せます。</p> <p>それで比較(<code>diff -y --suppress-common-lines &lt;(cd ~/photo;ls .../img_*|sort) &lt;(grep -vE -e '.{300,}' -e null /tmp/files.txt|sort)</code>)したところ、足りないものはわかりました。 ですが、何故かAPIで取ると3282個なのに 「コンテンツ 3283個」と表示されていたり... よく精査すると、なるほど、Google Photosが勝手に?作った、 <a href="https://photos.google.com/assistant">アシスタント</a>にある <code>MOVIE.mp4</code>(ムービー)や<code>...-EFFECTS.jpg</code>(スタイルを適用した写真)、 <code>...-PANO.jpg</code>(パノラマ)が含まれているから? いや、一つ(5230個と表示)はそれが原因で9個多く数が表示されていたのですが、 もう一つ、「コンテンツ 3283個」は、APIで取得するといくら見ても 3282個しかない、自動生成物もない、です。謎です。</p> <p>それと、EnrichmentとかいってTextやLocationとMapを入れられるんですけど、 それらを取得する術がなく、Textに書いたことを検索するとかも出来ず。 GUIから入れてみましたが、要素を追加する度にいちいち先頭に戻される、 移動すると他の要素もどこかに行ってしまうことがある、 等何だかなぁ、というものでした。 Googleならこんなもんじゃないだろー!</p> </div> </article> <article> <header> <h1 class="entry-title"><a href="/blog/2019/01/28/3-good-things-in-this-week/">3 Good Things in This Week</a></h1> <p class="meta"> <time datetime="2019-01-28T00:48:00+09:00" pubdate data-updated=true> <span class="month">Jan</span> <span class="day">28</span>, <span class="year">2019</span> </time> | <a href="http://u-ryo.github.io//blog/2019/01/28/3-good-things-in-this-week/#disqus_thread">Comments</a> </p> </header> <div class="entry-content"><p>また幸せになるため?に、 先週3つ良かったことを並べてみます。</p> <ul> <li>バイトで発表を何とか凌げたこと(でも本番のreportを書き上げる筈のこの土日、またなぁんにもしませんでした...orz)</li> <li>職場で定期本番リリースを無事?終えたこと(完全に付きっきりでしたけど。まぁ最初だから仕方ありませんよね。けど次のリリース、一人で出来るかな?)</li> <li>Paiza S Rank、CodeIQ S Rankを持っていたこと(でもこんな役に立たないもの自慢?という程のものではないにしても、何だか、ですが。みみっちぃなぁ...)</li> </ul> <p>あと、12月半月分の給料もいっぺんに出たので、 今回の総額が多かったこと、とか?</p> <p>良くないことは沢山思い付くんですけど、 それじゃぁいけないんですよね。 しかしまぁ、総体的には健気に生きています。</p> </div> </article> </article> <div class="pagination"> <div class="links"> <a class="prev" href="/">&larr; Newer</a> <a class="archive" href="/archives/">Blog Archives</a> <a class="next" href="/page/3/">Older &rarr;</a> </div> </div> </div> <aside class="sidebar"> <section> <h1>Recent Posts</h1> <ul id="recent_posts"> <li class="post"> <a href="/blog/2023/09/10/get-refresh-token-for-google-api/">Get Refresh Token for Google API</a> </li> <li class="post"> <a href="/blog/2023/09/10/get-refresh-token-for-google-api/">Get Refresh Token for Google API</a> </li> <li class="post"> <a href="/blog/2022/03/20/nhk-taiga-staff-reflection/">NHK Taiga Staff Reflection</a> </li> <li class="post"> <a href="/blog/2021/07/11/gradlew-stopped/">Gradlew Stopped</a> </li> <li class="post"> <a href="/blog/2021/07/11/ansible-for-docker/">Ansible for Docker</a> </li> </ul> </section> <section> <h1>GitHub Repos</h1> <a href="https://github.com/u-ryo">u-ryo</a> on GitHub </section> <section> <h1>About Me</h1> <p>A ~~Java~~ Ruby programmer in Tokyo.</p> </section> <section> <h1><a href="privacy.html">Privacy Policy</a></h1> </section> </aside> </div> </div> <footer role="contentinfo"><p> Copyright &copy; 2023 - u-ryo - <span class="credit">Powered by <a href="http://sysgears.com/grain/">Grain</a></span> </p> </footer> <script type="text/javascript">
  var disqus_shortname = "uryooo";
  
    // As `page.comments` is empty, we must be on the index page.
    var disqus_script = 'count.js';
  
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script> <div id="fb-root"></div> <script>
    (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {return;}
      js = d.createElement(s); js.id = id; js.async = true;
      js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
  </script> <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script> <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script> </body> </html>